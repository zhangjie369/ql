/**
 * é€”è™å…»è½¦æ¯æ—¥ç­¾åˆ° (é’é¾™ Node.js ç‰ˆæœ¬)
 * ç¯å¢ƒå˜é‡:
 * export TUHU_TOKEN='["Bearer token1","Bearer token2"]'
 * export TUHU_BLACKBOX='xxxxxxx'
 */

const axios = require("axios");

let tokens = [];
let blackbox = process.env.TUHU_BLACKBOX || "";

(async () => {
  console.log("ğŸ“¢ é€”è™å…»è½¦ç­¾åˆ°å¼€å§‹...");

  try {
    tokens = JSON.parse(process.env.TUHU_TOKEN || "[]");
  } catch (e) {
    console.log("âŒ TUHU_TOKEN æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨ JSON æ•°ç»„æ ¼å¼ï¼");
    return;
  }

  if (tokens.length === 0) {
    console.log("âŒ æœªé…ç½® TUHU_TOKEN");
    return;
  }

  for (let i = 0; i < tokens.length; i++) {
    console.log(`\n===== è´¦å· ${i + 1} å¼€å§‹æ‰§è¡Œ =====`);
    let token = tokens[i];

    await checkIn(token, "è½¯ä»¶");   // è½¯ä»¶ç­¾åˆ°
    await checkIn(token, "å¾®ä¿¡");   // å¾®ä¿¡ç­¾åˆ°
    await getUserScore(token);      // æŸ¥è¯¢ç§¯åˆ†
  }

  console.log("\nâœ… æ‰€æœ‰è´¦å·æ‰§è¡Œå®Œæˆ");
})();

async function checkIn(token, type) {
  let url = "https://api.tuhu.cn/User/UserCheckInVersion1";
  let headers = {
    Authorization: token,
    blackbox: blackbox,
    "Content-Type": "application/json",
  };
  let body = { checkInSource: type === "è½¯ä»¶" ? 1 : 2 };

  try {
    let { data } = await axios.post(url, body, { headers });
    if (data?.IsSuccess) {
      console.log(`ğŸ‰ ${type}ç­¾åˆ°æˆåŠŸ: +${data.Result.Point}åˆ†, è¿ç»­ç­¾åˆ°${data.Result.CheckInDay}/7å¤©`);
    } else {
      console.log(`âš ï¸ ${type}ç­¾åˆ°å¤±è´¥: ${data?.Message || "æœªçŸ¥é”™è¯¯"}`);
    }
  } catch (e) {
    console.log(`âŒ ${type}ç­¾åˆ°å¼‚å¸¸: ${e.message}`);
  }
}

async function getUserScore(token) {
  let url = "https://api.tuhu.cn/User/GetUserScore";
  let headers = { Authorization: token, blackbox: blackbox };

  try {
    let { data } = await axios.get(url, { headers });
    if (data?.IsSuccess) {
      console.log(`ğŸ’° å½“å‰ç§¯åˆ†: ${data.Result.Score}, å¯æŠµç°: ${data.Result.Amount} å…ƒ`);
    } else {
      console.log(`âš ï¸ ç§¯åˆ†æŸ¥è¯¢å¤±è´¥: ${data?.Message || "æœªçŸ¥é”™è¯¯"}`);
    }
  } catch (e) {
    console.log(`âŒ ç§¯åˆ†æŸ¥è¯¢å¼‚å¸¸: ${e.message}`);
  }
}
